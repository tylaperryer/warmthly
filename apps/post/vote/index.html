<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="/lego/components/warmthly-head.js"></script>
  <script type="module" src="/lego/components/warmthly-header.js"></script>
  <script type="module" src="/lego/components/warmthly-stoplight.js"></script>
  <script type="module" src="/lego/components/warmthly-reading-level.js"></script>
  <script type="module" src="/lego/components/warmthly-font-loader.js"></script>
  <script type="module" src="/lego/components/warmthly-breadcrumb.js"></script>
  <script type="module" src="/lego/components/warmthly-language-switcher.js"></script>
  <script type="module" src="/lego/utils/init.js"></script>
  <script type="module">
    import { initReadingLevel } from '/lego/utils/reading-level.js';
    import { initAbbreviations } from '/lego/utils/abbreviations.js';
    import { initGlossary } from '/lego/utils/glossary.js';
    import { initPronunciation } from '/lego/utils/pronunciation.js';
    initReadingLevel();
    initAbbreviations();
    initGlossary();
    initPronunciation();
  </script>
  <warmthly-head 
    title="Vote - Warmthly"
    description="Participate in organizational decisions and dissolution votes"
    app="post"
    viewport="1.0"
    preconnects="https://www.warmthly.org, https://post.warmthly.org">
  </warmthly-head>
  
  <style>
    /* Hide body until CSS loads to prevent FOUC */
    body:not(.css-loaded) {
      visibility: hidden;
      opacity: 0;
    }
    body.css-loaded {
      visibility: visible;
      opacity: 1;
      transition: opacity 0.2s ease-in-out;
    }
  </style>
  
</head>
<body class="fonts-loading">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <warmthly-header app="post"></warmthly-header>
  
  <div style="display: flex; gap: 1rem; justify-content: flex-end; padding: 1rem; align-items: center;">
    <warmthly-language-switcher></warmthly-language-switcher>
    <warmthly-reading-level></warmthly-reading-level>
    <warmthly-stoplight app="post"></warmthly-stoplight>
  </div>

  <div class="container container-narrow" id="main-content" role="main">
    <h1 class="page-title" data-reading-level-content>The Dissolution Vote</h1>
    <p class="main-text" data-reading-level-content>
      Our commitment is to our mission and values: Transparency, Honesty, Humility, and Empathy. If we fail to uphold them, we believe we should cease to exist. This page is our community-held kill switch.
    </p>

    <div class="section">
        <h2 class="section-title" data-reading-level-content>A Legally Binding Promise</h2>
        <p data-reading-level-content>
            This is not a survey. The Dissolution Vote is a legally binding mechanism enshrined in the bylaws of our organization. Should the vote count reach <strong>100,000</strong>, it will trigger a formal, legally mandated process to dissolve Warmthly. All remaining assets will be transferred to a predetermined successor charity dedicated to mental health and empathy, ensuring our mission outlives our organization. Your vote is your power.
        </p>
    </div>
    
    <div class="section vote-section">
      <h2 class="section-title" data-reading-level-content>Should Warmthly be dissolved?</h2>
      
      <!-- Parliamentary Chamber -->
      <div class="parliamentary-chamber">
        <div class="chamber-header">
          <h3 class="chamber-title">The Chamber</h3>
          <p class="chamber-subtitle">Each vote is represented as a seat in the chamber</p>
        </div>
        
        <div class="parliamentary-seats">
          <!-- Yes Section (Left side) -->
          <div class="seats-section yes-section">
            <div class="section-label">
              <span class="section-label-icon">‚ùå</span>
              <span>Yes, Dissolve</span>
            </div>
            <div class="seats-grid" id="yesSeatsGrid">
              <!-- Seats will be generated by JavaScript -->
            </div>
          </div>
          
          <!-- No Section (Right side) -->
          <div class="seats-section no-section">
            <div class="section-label">
              <span class="section-label-icon">‚úÖ</span>
              <span>No, Continue</span>
            </div>
            <div class="seats-grid" id="noSeatsGrid">
              <!-- Seats will be generated by JavaScript -->
            </div>
          </div>
        </div>
        
        <!-- Vote Statistics -->
        <div class="vote-stats">
          <div class="vote-count">
            <span class="vote-count-label">Current Votes</span>
            <span class="vote-count-value" id="voteCountText">0</span>
          </div>
          <div class="vote-threshold">
            <strong>100,000</strong> votes required for dissolution
          </div>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-indicator">
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div style="text-align: center; font-family: 'Inter', sans-serif; font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">
            <span id="progressPercentage">0%</span> of threshold reached
          </div>
        </div>
      </div>

      <!-- Vote Buttons -->
      <div class="vote-buttons">
        <button class="vote-button" id="yesButton" aria-label="Yes, dissolve Warmthly">Yes, dissolve.</button>
        <button class="vote-button" id="noButton" aria-label="No, continue Warmthly">No, continue.</button>
      </div>

      <p class="vote-note" id="voteStatus">Please cast your vote.</p>
      <div id="errorMessage" class="error-message" role="alert" aria-live="polite"></div>
    </div>
  </div>
  
  <!-- Firebase SDK - Load dynamically when needed (Performance Optimization) -->
  <script>
    // Dynamic Firebase loader (Performance Optimization)
    let firebasePromise = null;
    async function loadFirebase() {
          if (window.firebase) {
                return window.firebase;
          }
          if (firebasePromise) {
                return firebasePromise;
          }
          firebasePromise = new Promise((resolve, reject) => {
                const scripts = [
                  { src: 'https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js' },
                  { src: 'https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js' }
                ];
                let loaded = 0;
                scripts.forEach((scriptInfo, index) => {
                  const script = document.createElement('script');
                  script.src = scriptInfo.src;
                  script.async = true;
                  script.onload = () => {
                        loaded++;
                        if (loaded === scripts.length && window.firebase) {
                              resolve(window.firebase);
                        }
                  };
                  script.onerror = () => reject(new Error('Failed to load Firebase'));
                  document.head.appendChild(script);
                });
          });
          return firebasePromise;
    }
    
    (async function() {
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      if (firebaseConfig.apiKey === "YOUR_API_KEY" || 
          firebaseConfig.projectId === "YOUR_PROJECT_ID") {
        const errorEl = document.getElementById('errorMessage');
        if (errorEl) {
          errorEl.textContent = 'Voting service is not configured. Please contact the administrator.';
          errorEl.classList.add('visible');
        }
      } else {
        try {
          await loadFirebase();
          window.firebase.initializeApp(firebaseConfig);
        } catch (error) {
          const errorEl = document.getElementById('errorMessage');
          if (errorEl) {
            errorEl.textContent = 'Failed to initialize voting service. Please refresh the page.';
            errorEl.classList.add('visible');
          }
        }
      }
      
      if (window.firebase && window.firebase.apps.length > 0) {
        const database = window.firebase.database();
      const voteRef = database.ref('dissolution/votes');
      const VOTE_THRESHOLD = 100000;

      const voteCountText = document.getElementById('voteCountText');
      const progressBar = document.getElementById('progressBar');
      const yesButton = document.getElementById('yesButton');
      const noButton = document.getElementById('noButton');
      const voteStatus = document.getElementById('voteStatus');
      const errorMessage = document.getElementById('errorMessage');

      function showError(message) {
        if (errorMessage) {
          errorMessage.textContent = message;
          errorMessage.classList.add('visible');
          voteStatus.style.display = 'none';
        }
      }

      function hideError() {
        if (errorMessage) {
          errorMessage.classList.remove('visible');
          voteStatus.style.display = 'block';
        }
      }

      const yesSeatsGrid = document.getElementById('yesSeatsGrid');
      const noSeatsGrid = document.getElementById('noSeatsGrid');
      const progressPercentage = document.getElementById('progressPercentage');
      
      // Emojis for seats
      const yesEmojis = ['‚ùå', 'üö´', '‚õî', 'üõë', 'üî¥'];
      const noEmojis = ['‚úÖ', '‚úì', '‚úîÔ∏è', 'üü¢', 'üíö'];
      
      function createSeat(isYes, index) {
        const seat = document.createElement('div');
        seat.className = `seat ${isYes ? 'yes-seat' : 'no-seat'}`;
        const emojis = isYes ? yesEmojis : noEmojis;
        seat.textContent = emojis[index % emojis.length];
        seat.setAttribute('aria-label', `${isYes ? 'Yes' : 'No'} vote ${index + 1}`);
        seat.style.animationDelay = `${(index % 50) * 0.02}s`;
        return seat;
      }
      
      function updateParliamentaryLayout(votes) {
        // Clear existing seats
        yesSeatsGrid.innerHTML = '';
        noSeatsGrid.innerHTML = '';
        
        // For demonstration, we'll show a sample of seats (up to 200 visible)
        // In reality, you'd want to show all votes or a representative sample
        const maxVisibleSeats = 200;
        const visibleVotes = Math.min(votes, maxVisibleSeats);
        
        // Distribute votes (for demo, assume 60% yes, 40% no - adjust based on actual data)
        // In production, you'd track yes/no votes separately
        const yesVotes = Math.floor(visibleVotes * 0.6);
        const noVotes = visibleVotes - yesVotes;
        
        // Create yes seats
        for (let i = 0; i < yesVotes; i++) {
          yesSeatsGrid.appendChild(createSeat(true, i));
        }
        
        // Create no seats
        for (let i = 0; i < noVotes; i++) {
          noSeatsGrid.appendChild(createSeat(false, i));
        }
        
        // If there are more votes than visible, show indicator
        if (votes > maxVisibleSeats) {
          const moreIndicator = document.createElement('div');
          moreIndicator.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 1rem; font-family: Inter, sans-serif; font-size: 0.9rem; opacity: 0.7;';
          moreIndicator.textContent = `+${(votes - maxVisibleSeats).toLocaleString()} more votes`;
          yesSeatsGrid.appendChild(moreIndicator);
        }
      }

      voteRef.on('value', (snapshot) => {
        try {
          const votes = snapshot.val() || 0;
          voteCountText.textContent = votes.toLocaleString();
          const percentage = (votes / VOTE_THRESHOLD) * 100;
          progressBar.style.width = `${Math.min(percentage, 100)}%`;
          progressPercentage.textContent = `${Math.min(percentage, 100).toFixed(1)}%`;
          updateParliamentaryLayout(votes);
          hideError();
        } catch (error) {
          showError('Could not connect to voting service. Please refresh the page.');
        }
      }, (error) => {
        showError('Could not connect to voting service. Please refresh the page.');
      });

      const thirtyDaysInMillis = 30 * 24 * 60 * 60 * 1000;
      let voteData = null;
      try {
        voteData = JSON.parse(localStorage.getItem('warmthly_vote_data'));
      } catch (e) {
        voteData = null;
      }

      function updateUIBasedOnVote() {
        const now = new Date().getTime();
        if (!voteData) {
          voteStatus.textContent = "Please cast your vote.";
          yesButton.disabled = false;
          noButton.disabled = false;
          return;
        }

        const timeSinceVote = now - voteData.timestamp;
        if (timeSinceVote < thirtyDaysInMillis) {
          yesButton.disabled = true;
          noButton.disabled = true;
          const daysRemaining = Math.ceil((thirtyDaysInMillis - timeSinceVote) / (1000 * 60 * 60 * 24));
          voteStatus.textContent = `Thank you for your vote. You can cast a new vote in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}.`;
        } else {
          voteStatus.textContent = "Your previous vote cooldown has ended. You may cast a new vote.";
          yesButton.disabled = false;
          noButton.disabled = false;
        }
      }

      yesButton.addEventListener('click', () => {
        if (yesButton.disabled) return;
        
        try {
          voteRef.transaction((currentVotes) => {
            return (currentVotes || 0) + 1;
          }, (error, committed, snapshot) => {
            if (error) {
              showError('Failed to cast vote. Please try again.');
              return;
            }
            if (committed) {
              const now = new Date().getTime();
              voteData = { vote: 'yes', timestamp: now };
              try {
                localStorage.setItem('warmthly_vote_data', JSON.stringify(voteData));
              } catch (e) {
              }
              updateUIBasedOnVote();
            }
          });
        } catch (error) {
          showError('Failed to cast vote. Please refresh and try again.');
        }
      });

      noButton.addEventListener('click', () => {
        if (noButton.disabled) return;
        
        const now = new Date().getTime();
        voteData = { vote: 'no', timestamp: now };
        try {
          localStorage.setItem('warmthly_vote_data', JSON.stringify(voteData));
        } catch (e) {
        }
        updateUIBasedOnVote();
      });

      updateUIBasedOnVote();
    }
  </script>
  
  <warmthly-font-loader></warmthly-font-loader>
</body>
</html>

