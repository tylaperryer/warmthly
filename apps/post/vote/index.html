<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="/lego/web-components/warmthly-head.js"></script>
  <script type="module" src="/lego/web-components/warmthly-header.js"></script>
  <script type="module" src="/lego/web-components/warmthly-stoplight.js"></script>
  <script type="module" src="/lego/web-components/warmthly-font-loader.js"></script>
  <warmthly-head 
    title="Vote - Warmthly"
    description="Participate in organizational decisions and dissolution votes"
    app="post"
    viewport="1.0"
    preconnects="https://www.warmthly.org, https://post.warmthly.org">
  </warmthly-head>
  
</head>
<body class="fonts-loading">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <warmthly-header app="post"></warmthly-header>
  
  <warmthly-stoplight app="post"></warmthly-stoplight>

  <div class="container container-narrow" id="main-content" role="main">
    <h1 class="page-title">The Dissolution Vote</h1>
    <p class="main-text">
      Our commitment is to our mission and values: Transparency, Honesty, Humility, and Empathy. If we fail to uphold them, we believe we should cease to exist. This page is our community-held kill switch.
    </p>

    <div class="section">
        <h2 class="section-title">A Legally Binding Promise</h2>
        <p>
            This is not a survey. The Dissolution Vote is a legally binding mechanism enshrined in the bylaws of our organization. Should the vote count reach <strong>100,000</strong>, it will trigger a formal, legally mandated process to dissolve Warmthly. All remaining assets will be transferred to a predetermined successor charity dedicated to mental health and empathy, ensuring our mission outlives our organization. Your vote is your power.
        </p>
    </div>
    
    <div class="section">
      <h2 class="section-title">Should Warmthly be dissolved?</h2>
      
      <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="vote-stats">
          <span id="voteCountText">... votes</span>
          <span>100,000 vote threshold</span>
      </div>

      <div class="vote-buttons">
        <button class="vote-button" id="yesButton" aria-label="Yes, dissolve Warmthly">Yes, dissolve.</button>
        <button class="vote-button" id="noButton" aria-label="No, continue Warmthly">No, continue.</button>
      </div>

      <p class="vote-note" id="voteStatus">Please cast your vote.</p>
      <div id="errorMessage" class="error-message" role="alert" aria-live="polite"></div>
    </div>
  </div>
  
  <!-- Firebase JavaScript SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // ===================================================================
    // SECURITY IMPLEMENTATION GUIDE
    // ===================================================================
    // 
    // ⚠️ CRITICAL: The current implementation uses client-side localStorage
    // and direct database writes, which are NOT secure for production.
    // 
    // To secure this voting system, you MUST implement:
    // 
    // 1. FIREBASE CLOUD FUNCTION (castVote)
    //    - Create a Cloud Function that handles all vote counting server-side
    //    - The function should:
    //      a. Extract the user's IP address from the request
    //      b. Check a 'vote_logs' collection to see if that IP voted in the last 30 days
    //      c. If yes, return an error
    //      d. If no, increment the vote count and log the IP + timestamp
    //    - Example function structure:
    //      exports.castVote = functions.https.onCall(async (data, context) => {
    //        const ip = context.rawRequest.ip || context.rawRequest.connection.remoteAddress;
    //        // Check vote_logs for IP
    //        // If allowed, increment votes and log IP
    //        // Return success/error
    //      });
    // 
    // 2. SECURE DATABASE RULES
    //    - Set Firebase Realtime Database rules to make 'dissolution/votes' read-only:
    //      {
    //        "rules": {
    //          "dissolution": {
    //            "votes": {
    //              ".read": true,
    //              ".write": false  // Only Cloud Functions can write
    //            }
    //          }
    //        }
    //      }
    // 
    // 3. UPDATE FRONTEND CODE
    //    - Replace direct voteRef.transaction() calls with:
    //      const castVote = firebase.functions().httpsCallable('castVote');
    //      castVote({ vote: 'yes' }).then(result => { ... });
    // 
    // ===================================================================
    
    // --- 1. PASTE YOUR FIREBASE CONFIGURATION HERE ---
    // SECURITY NOTE: This Firebase configuration must be properly configured before deployment.
    // Replace all placeholder values with your actual Firebase project credentials.
    // If not configured, the voting feature will not work.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // ---------------------------------------------------

    // Initialize Firebase - validate configuration first
    if (firebaseConfig.apiKey === "YOUR_API_KEY" || 
        firebaseConfig.projectId === "YOUR_PROJECT_ID") {
      console.error('[vote.html] Firebase configuration not set. Please configure firebaseConfig with your actual Firebase project credentials.');
      // Show error to user if error element exists
      const errorEl = document.getElementById('errorMessage');
      if (errorEl) {
        errorEl.textContent = 'Voting service is not configured. Please contact the administrator.';
        errorEl.classList.add('visible');
      }
    } else {
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (error) {
        console.error('[vote.html] Firebase initialization failed:', error);
        const errorEl = document.getElementById('errorMessage');
        if (errorEl) {
          errorEl.textContent = 'Failed to initialize voting service. Please refresh the page.';
          errorEl.classList.add('visible');
        }
      }
    }
    
    // Only proceed if Firebase was initialized successfully
    if (firebase.apps.length > 0) {
      const database = firebase.database();
      const voteRef = database.ref('dissolution/votes');
      const VOTE_THRESHOLD = 100000;

    // Get DOM elements
    const voteCountText = document.getElementById('voteCountText');
    const progressBar = document.getElementById('progressBar');
    const yesButton = document.getElementById('yesButton');
    const noButton = document.getElementById('noButton');
    const voteStatus = document.getElementById('voteStatus');
    const errorMessage = document.getElementById('errorMessage');

    // Helper function to show error
    function showError(message) {
      if (errorMessage) {
        errorMessage.textContent = message;
        errorMessage.classList.add('visible');
        voteStatus.style.display = 'none';
      }
    }

    // Helper function to hide error
    function hideError() {
      if (errorMessage) {
        errorMessage.classList.remove('visible');
        voteStatus.style.display = 'block';
      }
    }

      // Listen for real-time updates to the vote count with error handling
      voteRef.on('value', (snapshot) => {
      try {
        const votes = snapshot.val() || 0;
        voteCountText.textContent = `${votes.toLocaleString()} votes`;
        const percentage = (votes / VOTE_THRESHOLD) * 100;
        progressBar.style.width = `${Math.min(percentage, 100)}%`;
        hideError();
      } catch (error) {
        console.error('Error reading vote count:', error);
        showError('Could not connect to voting service. Please refresh the page.');
      }
      }, (error) => {
        console.error('Firebase connection error:', error);
        showError('Could not connect to voting service. Please refresh the page.');
      });

    // --- REVISED Voting Logic: Universal 30-Day Cooldown ---
    // NOTE: This is a client-side implementation. For production, you MUST implement:
    // 1. A Firebase Cloud Function (castVote) that handles all voting server-side
    // 2. IP-based throttling in the Cloud Function
    // 3. Secure database rules that prevent direct client writes
    // See security notes below for implementation details.
    
    const thirtyDaysInMillis = 30 * 24 * 60 * 60 * 1000;
    let voteData = null;
    try {
      voteData = JSON.parse(localStorage.getItem('warmthly_vote_data'));
    } catch (e) {
      console.warn('Error reading vote data from localStorage:', e);
      voteData = null;
    }

    function updateUIBasedOnVote() {
        const now = new Date().getTime();
        if (!voteData) {
            voteStatus.textContent = "Please cast your vote.";
            yesButton.disabled = false;
            noButton.disabled = false;
            return;
        }

        const timeSinceVote = now - voteData.timestamp;
        if (timeSinceVote < thirtyDaysInMillis) {
            // Still in cooldown period
            yesButton.disabled = true;
            noButton.disabled = true;
            const daysRemaining = Math.ceil((thirtyDaysInMillis - timeSinceVote) / (1000 * 60 * 60 * 24));
            voteStatus.textContent = `Thank you for your vote. You can cast a new vote in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}.`;
        } else {
            // Cooldown has expired
            voteStatus.textContent = "Your previous vote cooldown has ended. You may cast a new vote.";
            yesButton.disabled = false;
            noButton.disabled = false;
        }
    }

    // "Yes, dissolve" button - increments the vote count
    yesButton.addEventListener('click', () => {
        if (yesButton.disabled) return;
        
        // SECURITY NOTE: In production, this should call a Firebase Cloud Function instead
        // Example: httpsCallable('castVote', { vote: 'yes' })
        // The Cloud Function will handle IP throttling and vote counting server-side
        
        try {
          // Use a transaction to safely increment the vote count
            voteRef.transaction((currentVotes) => {
            return (currentVotes || 0) + 1;
          }, (error, committed, snapshot) => {
            if (error) {
              console.error('Transaction failed:', error);
              showError('Failed to cast vote. Please try again.');
              return;
            }
            if (committed) {
              const now = new Date().getTime();
              voteData = { vote: 'yes', timestamp: now };
              try {
                localStorage.setItem('warmthly_vote_data', JSON.stringify(voteData));
              } catch (e) {
                console.warn('Failed to save vote to localStorage:', e);
              }
              updateUIBasedOnVote();
            }
          });
        } catch (error) {
          console.error('Error casting vote:', error);
          showError('Failed to cast vote. Please refresh and try again.');
        }
    });

    // "No, continue" button - does not increment vote count, just records preference
    noButton.addEventListener('click', () => {
        if (noButton.disabled) return;
        
        // SECURITY NOTE: In production, this could optionally call a Cloud Function
        // to track "no" votes separately for analytics, but it doesn't affect dissolution count
        
        const now = new Date().getTime();
        voteData = { vote: 'no', timestamp: now };
        try {
          localStorage.setItem('warmthly_vote_data', JSON.stringify(voteData));
        } catch (e) {
          console.warn('Failed to save vote to localStorage:', e);
        }
        updateUIBasedOnVote();
    });

      // Initial UI setup on page load
      updateUIBasedOnVote();
    } // End of Firebase initialization check
  </script>
  
  <!-- Font Loader Component -->
  <warmthly-font-loader></warmthly-font-loader>
</body>
</html>

