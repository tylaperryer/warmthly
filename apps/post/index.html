<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="/lego/web-components/warmthly-head.js"></script>
  <script type="module" src="/lego/web-components/warmthly-header.js"></script>
  <script type="module" src="/lego/web-components/warmthly-stoplight.js"></script>
  <script type="module" src="/lego/web-components/warmthly-font-loader.js"></script>
  <warmthly-head 
    title="Vote - Warmthly"
    description="Participate in organizational decisions and dissolution votes"
    app="post"
    viewport="1.0"
    preconnects="https://www.warmthly.org, https://post.warmthly.org">
  </warmthly-head>
  
  <style>
    /* Hide body until CSS loads - base.css handles the animation */
    body:not(.css-loaded) {
      visibility: hidden;
      opacity: 0;
    }
    body.css-loaded {
      visibility: visible;
      opacity: 1;
      transition: opacity 0.2s ease-in-out;
    }
    body.fonts-loaded {
      opacity: 1;
      visibility: visible;
    }
  </style>
  
</head>
<body class="fonts-loading">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <warmthly-header app="post"></warmthly-header>
  
  <warmthly-stoplight app="post"></warmthly-stoplight>

  <div class="container" id="main-content" role="main">
    <div class="hero-section">
      <h1 class="page-title">Vote</h1>
      <p class="subtitle">
        Our commitment is to our mission and values: Transparency, Honesty, Humility, and Empathy. If we fail to uphold them, we believe we should cease to exist. This is our community-held dissolution voteâ€”a legally binding mechanism that will trigger Warmthly's dissolution if it reaches 100,000 votes. All remaining assets will be transferred to a predetermined successor charity dedicated to mental health and empathy.
      </p>
    </div>

    <!-- Vote Bar in Box -->
    <div class="vote-bar-box">
      <div class="vote-bar-container">
        <div class="vote-bar-fill" id="voteBar" style="width: 0%"></div>
      </div>
      <div class="vote-bar-text" id="voteBarText">0 votes</div>
    </div>

    <!-- Vote Buttons -->
    <div class="vote-buttons-container">
      <button class="vote-btn" id="yesButton" aria-label="Yes, dissolve Warmthly">Yes, dissolve</button>
      <button class="vote-btn" id="noButton" aria-label="No, continue Warmthly">No, continue</button>
    </div>

    <p class="site-footer-inline">CC BY-NC-SA Warmthly 2025. Sourced from <a href="https://github.com/tylaperryer/warmthly" target="_blank" rel="noopener noreferrer">GitHub</a>. Our work is not ours, it's yours.</p>
  </div>
  
  <script>
    const VOTE_STORAGE_KEY = 'warmthly_dissolution_votes';
    const USER_VOTE_KEY = 'warmthly_user_vote';
    const VOTE_THRESHOLD = 100000;
    const THIRTY_DAYS_IN_MILLIS = 30 * 24 * 60 * 60 * 1000;

    // Get vote data from localStorage
    function getVoteData() {
      try {
        const data = localStorage.getItem(VOTE_STORAGE_KEY);
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        console.error('Error reading vote data:', e);
      }
      return { yes: 0, no: 0 };
    }

    // Save vote data to localStorage
    function saveVoteData(voteData) {
      try {
        localStorage.setItem(VOTE_STORAGE_KEY, JSON.stringify(voteData));
        return true;
      } catch (e) {
        console.error('Error saving vote data:', e);
        return false;
      }
    }

    // Get user vote record
    function getUserVote() {
      try {
        const data = localStorage.getItem(USER_VOTE_KEY);
        if (data) {
          return JSON.parse(data);
        }
      } catch (e) {
        return null;
      }
      return null;
    }

    // Save user vote with timestamp
    function saveUserVote() {
      try {
        const voteRecord = {
          timestamp: Date.now()
        };
        localStorage.setItem(USER_VOTE_KEY, JSON.stringify(voteRecord));
        return true;
      } catch (e) {
        return false;
      }
    }

    // Check if user can vote (30 day cooldown)
    function canUserVote() {
      const userVote = getUserVote();
      if (!userVote) {
        return true;
      }

      const timeSinceVote = Date.now() - userVote.timestamp;
      return timeSinceVote >= THIRTY_DAYS_IN_MILLIS;
    }

    // Update the bar display
    function updateBar() {
      const voteData = getVoteData();
      const totalVotes = voteData.yes + voteData.no;
      const percentage = Math.min((totalVotes / VOTE_THRESHOLD) * 100, 100);
      
      const voteBar = document.getElementById('voteBar');
      const voteBarText = document.getElementById('voteBarText');

      if (voteBar) {
        setTimeout(() => {
          voteBar.style.width = `${percentage}%`;
        }, 10);
      }

      if (voteBarText) {
        voteBarText.textContent = `${totalVotes.toLocaleString()} votes`;
      }
    }

    // Update UI based on vote status
    function updateUI() {
      const yesButton = document.getElementById('yesButton');
      const noButton = document.getElementById('noButton');
      const canVote = canUserVote();

      if (!canVote) {
        if (yesButton) {
          yesButton.disabled = true;
          yesButton.classList.add('voted');
        }
        if (noButton) {
          noButton.disabled = true;
          noButton.classList.add('voted');
        }
      } else {
        if (yesButton) {
          yesButton.disabled = false;
          yesButton.classList.remove('voted');
        }
        if (noButton) {
          noButton.disabled = false;
          noButton.classList.remove('voted');
        }
      }
    }

    // Cast a vote
    function castVote(voteType) {
      if (!canUserVote()) {
        return false;
      }

      const voteData = getVoteData();
      voteData[voteType] = (voteData[voteType] || 0) + 1;

      if (saveVoteData(voteData) && saveUserVote()) {
        updateBar();
        updateUI();
        return true;
      }

      return false;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const yesButton = document.getElementById('yesButton');
      const noButton = document.getElementById('noButton');

      // Initial display
      updateBar();
      updateUI();

      // Vote button handlers
      if (yesButton) {
        yesButton.addEventListener('click', () => {
          if (yesButton.disabled) return;
          castVote('yes');
        });
      }

      if (noButton) {
        noButton.addEventListener('click', () => {
          if (noButton.disabled) return;
          castVote('no');
        });
      }
    });
  </script>
  
  <warmthly-font-loader></warmthly-font-loader>
</body>
</html>

