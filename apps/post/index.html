<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module" src="/lego/web-components/warmthly-head.js"></script>
  <script type="module" src="/lego/web-components/warmthly-header.js"></script>
  <script type="module" src="/lego/web-components/warmthly-stoplight.js"></script>
  <script type="module" src="/lego/web-components/warmthly-font-loader.js"></script>
  <warmthly-head 
    title="Vote - Warmthly"
    description="Participate in organizational decisions and dissolution votes"
    app="post"
    viewport="1.0"
    preconnects="https://www.warmthly.org, https://post.warmthly.org">
  </warmthly-head>
  
  <style>
    /* Hide body until CSS loads - base.css handles the animation */
    body:not(.css-loaded) {
      visibility: hidden;
      opacity: 0;
    }
    body.css-loaded {
      visibility: visible;
      opacity: 1;
      transition: opacity 0.2s ease-in-out;
    }
    body.fonts-loaded {
      opacity: 1;
      visibility: visible;
    }
  </style>
  
</head>
<body class="fonts-loading">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <warmthly-header app="post"></warmthly-header>
  
  <warmthly-stoplight app="post"></warmthly-stoplight>

  <div class="container container-narrow" id="main-content" role="main">
    <h1 class="page-title">The Dissolution Vote</h1>
    <p class="main-text">
      Our commitment is to our mission and values: Transparency, Honesty, Humility, and Empathy. If we fail to uphold them, we believe we should cease to exist. This page is our community-held kill switch.
    </p>

    <div class="section">
        <h2 class="section-title">A Legally Binding Promise</h2>
        <p>
            This is not a survey. The Dissolution Vote is a legally binding mechanism enshrined in the bylaws of our organization. Should the vote count reach <strong>100,000</strong>, it will trigger a formal, legally mandated process to dissolve Warmthly. All remaining assets will be transferred to a predetermined successor charity dedicated to mental health and empathy, ensuring our mission outlives our organization. Your vote is your power.
        </p>
    </div>
    
    <div class="section vote-section">
      <h2 class="section-title">Should Warmthly be dissolved?</h2>
      
      <!-- Vote Bar Chart -->
      <div class="vote-chart-container">
        <!-- Yes Votes Bar -->
        <div class="vote-bar-section">
          <div class="vote-bar-label">
            <span class="vote-bar-icon">❌</span>
            <span class="vote-bar-text">Yes, Dissolve</span>
            <span class="vote-bar-count" id="yesVoteCount">0</span>
          </div>
          <div class="vote-bar-wrapper">
            <div class="vote-bar vote-bar-yes" id="yesBar" style="width: 0%">
              <span class="vote-bar-fill-text" id="yesBarText">0</span>
            </div>
          </div>
        </div>
        
        <!-- No Votes Bar -->
        <div class="vote-bar-section">
          <div class="vote-bar-label">
            <span class="vote-bar-icon">✅</span>
            <span class="vote-bar-text">No, Continue</span>
            <span class="vote-bar-count" id="noVoteCount">0</span>
          </div>
          <div class="vote-bar-wrapper">
            <div class="vote-bar vote-bar-no" id="noBar" style="width: 0%">
              <span class="vote-bar-fill-text" id="noBarText">0</span>
            </div>
          </div>
        </div>
        
        <!-- Total Votes -->
        <div class="vote-total">
          <span class="vote-total-label">Total Votes:</span>
          <span class="vote-total-value" id="totalVoteCount">0</span>
        </div>
        
        <!-- Threshold Info -->
        <div class="vote-threshold-info">
          <strong>100,000</strong> votes required for dissolution
        </div>
      </div>

      <!-- Vote Buttons -->
      <div class="vote-buttons">
        <button class="vote-button" id="yesButton" aria-label="Yes, dissolve Warmthly">Yes, dissolve.</button>
        <button class="vote-button" id="noButton" aria-label="No, continue Warmthly">No, continue.</button>
      </div>

      <p class="vote-note" id="voteStatus">Please cast your vote.</p>
      <div id="errorMessage" class="error-message" role="alert" aria-live="polite"></div>
      <p class="site-footer-inline">CC BY-NC-SA Warmthly 2025. Sourced from <a href="https://github.com/tylaperryer/warmthly" target="_blank" rel="noopener noreferrer">GitHub</a>. Our work is not ours, it's yours.</p>
    </div>
  </div>
  
  <!-- Firebase SDK for Realtime Database -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, get, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    // Replace these values with your Firebase project details:
    // 1. Go to https://console.firebase.google.com/
    // 2. Create a new project (or select existing)
    // 3. Go to Project Settings (gear icon)
    // 4. Scroll down to "Your apps" section
    // 5. Click the web icon (</>) to add a web app
    // 6. Copy the config values from there
    // 7. Also enable Realtime Database in Firebase Console:
    //    - Go to "Realtime Database" in left menu
    //    - Click "Create Database"
    //    - Choose your region
    //    - Start in "Test mode" (we'll set rules below)
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyDexgT1qa34GPGnpmZ1iCvr3jigiwvZ5eE",
      authDomain: "post-vote-59ed2.firebaseapp.com",
      databaseURL: "https://post-vote-59ed2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "post-vote-59ed2",
      storageBucket: "post-vote-59ed2.firebasestorage.app",
      messagingSenderId: "170079221674",
      appId: "1:170079221674:web:58097403f2a85f829b5dd3"
    };

    const VOTE_THRESHOLD = 100000;
    const THIRTY_DAYS_IN_MILLIS = 30 * 24 * 60 * 60 * 1000;

    // Generate a unique browser ID for tracking votes
    function getBrowserId() {
      let browserId = localStorage.getItem('warmthly_browser_id');
      if (!browserId) {
        browserId = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        try {
          localStorage.setItem('warmthly_browser_id', browserId);
        } catch (e) {
          browserId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
      }
      return browserId;
    }

    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      const voteStatus = document.getElementById('voteStatus');
      if (errorMessage) {
        errorMessage.textContent = message;
        errorMessage.classList.add('visible');
        if (voteStatus) voteStatus.style.display = 'none';
      }
    }

    function hideError() {
      const errorMessage = document.getElementById('errorMessage');
      const voteStatus = document.getElementById('voteStatus');
      if (errorMessage) {
        errorMessage.classList.remove('visible');
        if (voteStatus) voteStatus.style.display = 'block';
      }
    }

    // Check if Firebase is configured
    if (firebaseConfig.apiKey === "YOUR_API_KEY" || 
        firebaseConfig.databaseURL === "YOUR_DATABASE_URL" ||
        firebaseConfig.projectId === "YOUR_PROJECT_ID") {
      showError('Firebase is not configured. Please update the firebaseConfig object with your Firebase project details.');
    } else {
      try {
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Database references
        const votesRef = ref(database, 'dissolution/votes');
        const userVotesRef = ref(database, 'dissolution/userVotes');

        // Update the bar chart display
        function updateBarChart(voteData) {
          const yesCount = voteData.yes || 0;
          const noCount = voteData.no || 0;
          const totalVotes = yesCount + noCount;
          
          const yesBar = document.getElementById('yesBar');
          const noBar = document.getElementById('noBar');
          const yesBarText = document.getElementById('yesBarText');
          const noBarText = document.getElementById('noBarText');
          const yesVoteCount = document.getElementById('yesVoteCount');
          const noVoteCount = document.getElementById('noVoteCount');
          const totalVoteCount = document.getElementById('totalVoteCount');

          // Calculate percentages (for display, max 100%)
          const maxVotes = Math.max(yesCount, noCount, 1);
          const yesPercentage = totalVotes > 0 ? (yesCount / maxVotes) * 100 : 0;
          const noPercentage = totalVotes > 0 ? (noCount / maxVotes) * 100 : 0;

          // Update bars with animation
          setTimeout(() => {
            if (yesBar) yesBar.style.width = `${yesPercentage}%`;
            if (noBar) noBar.style.width = `${noPercentage}%`;
          }, 10);

          // Update text
          if (yesBarText) yesBarText.textContent = yesCount.toLocaleString();
          if (noBarText) noBarText.textContent = noCount.toLocaleString();
          if (yesVoteCount) yesVoteCount.textContent = yesCount.toLocaleString();
          if (noVoteCount) noVoteCount.textContent = noCount.toLocaleString();
          if (totalVoteCount) totalVoteCount.textContent = totalVotes.toLocaleString();
        }

        // Check if user can vote
        async function canUserVote() {
          const browserId = getBrowserId();
          try {
            const userVoteSnapshot = await get(ref(database, `dissolution/userVotes/${browserId}`));
            if (!userVoteSnapshot.exists()) {
              return true;
            }
            
            const userVote = userVoteSnapshot.val();
            const timeSinceVote = Date.now() - userVote.timestamp;
            return timeSinceVote >= THIRTY_DAYS_IN_MILLIS;
          } catch (error) {
            console.error('Error checking user vote:', error);
            return true; // Allow vote if check fails
          }
        }

        // Update UI based on vote status
        async function updateUIBasedOnVote() {
          const yesButton = document.getElementById('yesButton');
          const noButton = document.getElementById('noButton');
          const voteStatus = document.getElementById('voteStatus');
          const browserId = getBrowserId();

          try {
            const userVoteSnapshot = await get(ref(database, `dissolution/userVotes/${browserId}`));
            
            if (!userVoteSnapshot.exists() || await canUserVote()) {
              if (voteStatus) voteStatus.textContent = "Please cast your vote.";
              if (yesButton) yesButton.disabled = false;
              if (noButton) noButton.disabled = false;
            } else {
              const userVote = userVoteSnapshot.val();
              const timeSinceVote = Date.now() - userVote.timestamp;
              const daysRemaining = Math.ceil((THIRTY_DAYS_IN_MILLIS - timeSinceVote) / (1000 * 60 * 60 * 24));
              if (voteStatus) {
                voteStatus.textContent = `Thank you for your vote. You can cast a new vote in ${daysRemaining} day${daysRemaining !== 1 ? 's' : ''}.`;
              }
              if (yesButton) yesButton.disabled = true;
              if (noButton) noButton.disabled = true;
            }
          } catch (error) {
            console.error('Error updating UI:', error);
            if (voteStatus) voteStatus.textContent = "Please cast your vote.";
            if (yesButton) yesButton.disabled = false;
            if (noButton) noButton.disabled = false;
          }
        }

        // Cast a vote
        async function castVote(voteType) {
          if (!(await canUserVote())) {
            showError('You have already voted. Please wait 30 days before voting again.');
            return false;
          }

          const browserId = getBrowserId();
          const voteRef = ref(database, `dissolution/votes/${voteType}`);
          const userVoteRef = ref(database, `dissolution/userVotes/${browserId}`);

          try {
            // Increment vote count
            const currentSnapshot = await get(voteRef);
            const currentCount = currentSnapshot.exists() ? currentSnapshot.val() : 0;
            await set(voteRef, currentCount + 1);

            // Record user vote with timestamp
            await set(userVoteRef, {
              vote: voteType,
              timestamp: Date.now(),
              browserId: browserId
            });

            hideError();
            await updateUIBasedOnVote();
            return true;
          } catch (error) {
            console.error('Error casting vote:', error);
            showError('Failed to cast vote. Please try again.');
            return false;
          }
        }

        // Listen for real-time vote updates
        onValue(votesRef, (snapshot) => {
          const voteData = snapshot.val() || { yes: 0, no: 0 };
          updateBarChart(voteData);
          hideError();
        }, (error) => {
          console.error('Error listening to votes:', error);
          showError('Could not connect to voting service. Please refresh the page.');
        });

        // Initialize UI
        document.addEventListener('DOMContentLoaded', () => {
          const yesButton = document.getElementById('yesButton');
          const noButton = document.getElementById('noButton');

          // Initial UI update
          updateUIBasedOnVote();

          // Vote button handlers
          if (yesButton) {
            yesButton.addEventListener('click', async () => {
              if (yesButton.disabled) return;
              yesButton.disabled = true;
              await castVote('yes');
              yesButton.disabled = false;
            });
          }

          if (noButton) {
            noButton.addEventListener('click', async () => {
              if (noButton.disabled) return;
              noButton.disabled = true;
              await castVote('no');
              noButton.disabled = false;
            });
          }
        });

      } catch (error) {
        console.error('Firebase initialization error:', error);
        showError('Failed to initialize voting service. Please check your Firebase configuration.');
      }
    }
  </script>
  
  <warmthly-font-loader></warmthly-font-loader>
</body>
</html>

