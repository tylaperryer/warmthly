# Consolidated All Checks Workflow
# Runs all checks in parallel and shows results in one place
# This replaces running multiple separate workflows

name: All Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

jobs:
  # Core checks: type checking, linting, formatting, tests
  core-checks:
    name: Core Checks (Type, Lint, Format, Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        id: type-check
        run: npm run type-check
        continue-on-error: true

      - name: Lint
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: Format check
        id: format
        run: npm run format:check
        continue-on-error: true

      - name: Validate i18n
        id: i18n
        run: npm run validate:i18n
        continue-on-error: true

      - name: Security audit
        id: security-audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Run tests with coverage
        id: tests
        run: npm run test:coverage -- --run
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: Save check results
        if: always()
        run: |
          echo "TYPE_CHECK=${{ steps.type-check.outcome }}" >> $GITHUB_ENV
          echo "LINT=${{ steps.lint.outcome }}" >> $GITHUB_ENV
          echo "FORMAT=${{ steps.format.outcome }}" >> $GITHUB_ENV
          echo "I18N=${{ steps.i18n.outcome }}" >> $GITHUB_ENV
          echo "SECURITY_AUDIT=${{ steps.security-audit.outcome }}" >> $GITHUB_ENV
          echo "TESTS=${{ steps.tests.outcome }}" >> $GITHUB_ENV

  # Build and bundle size checks
  build-checks:
    name: Build & Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: npm run build
        env:
          NODE_ENV: production
        continue-on-error: true

      - name: Analyze bundle sizes
        id: bundle-analyze
        run: npm run analyze:bundle
        continue-on-error: true

      - name: Check bundle size budgets
        id: bundle-check
        run: node scripts/check-bundle-size.js
        continue-on-error: true

      - name: Upload bundle analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            bundle-size-report.json
            dist/stats.html
          retention-days: 7
          if-no-files-found: ignore

  # E2E tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        id: build
        run: npm run build
        continue-on-error: true

      - name: Run E2E tests
        id: e2e
        run: npm run test:e2e
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

  # Accessibility checks
  accessibility:
    name: Accessibility
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        id: build
        run: npm run build
        continue-on-error: true

      - name: Create test-results directory
        run: mkdir -p test-results

      - name: Run accessibility tests
        id: a11y-tests
        run: npm run test:a11y
        continue-on-error: true

      - name: Audit accessibility
        id: a11y-audit
        run: npm run audit:accessibility
        continue-on-error: true

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: accessibility-report
          path: test-results/
          retention-days: 30
          if-no-files-found: ignore

  # SEO audit checks
  seo-audit:
    name: SEO Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate sitemaps
        id: sitemap
        run: npm run generate:sitemap
        continue-on-error: true

      - name: Validate structured data
        id: structured-data
        run: npm run validate:structured-data
        continue-on-error: true

      - name: Audit alt text
        id: alt-text
        run: npm run audit:alt-text
        continue-on-error: true

      - name: Generate SEO report
        id: seo-report
        run: npm run generate:seo-report
        continue-on-error: true

      - name: Audit accessibility (SEO)
        id: seo-a11y
        run: npm run audit:accessibility
        continue-on-error: true

      - name: Analyze link equity
        id: link-equity
        run: npm run analyze:link-equity
        continue-on-error: true

      - name: Validate semantic HTML
        id: semantic-html
        run: npm run validate:semantic-html
        continue-on-error: true

      - name: Detect broken links
        id: broken-links
        run: npm run detect:broken-links
        continue-on-error: true

      - name: Detect duplicate content
        id: duplicate-content
        run: npm run detect:duplicate-content
        continue-on-error: true

      - name: Validate URL structure
        id: url-structure
        run: npm run validate:url-structure
        continue-on-error: true

      - name: Optimize meta tags (analysis)
        id: meta-tags
        run: npm run optimize:meta-tags
        continue-on-error: true

      - name: Validate sitemaps
        id: validate-sitemap
        run: npm run validate:sitemap
        continue-on-error: true

      - name: Validate robots.txt
        id: robots
        run: npm run validate:robots
        continue-on-error: true

      - name: Calculate SEO score
        id: seo-score
        run: npm run calculate:seo-score
        continue-on-error: true

      - name: Upload SEO report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seo-report
          path: docs/SEO-AUDIT-REPORT.md
          retention-days: 30
          if-no-files-found: ignore

  # Security checks
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm-audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

      - name: CodeQL Analysis
        id: codeql
        uses: github/codeql-action/init@v4
        with:
          languages: javascript,typescript
        continue-on-error: true

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
        if: steps.codeql.outcome == 'success'
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        if: steps.codeql.outcome == 'success'
        continue-on-error: true

  # Lighthouse performance audit
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: npm run build
        continue-on-error: true

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        if: steps.build.outcome == 'success'
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  # Summary job that shows all results in one place
  summary:
    name: ğŸ“Š All Checks Summary
    runs-on: ubuntu-latest
    needs: [core-checks, build-checks, e2e-tests, accessibility, seo-audit, security-checks, lighthouse]
    if: always()
    
    steps:
      - name: Generate comprehensive summary
        run: |
          {
            echo "# All Checks Summary"
            echo ""
            echo "## Core Checks"
            echo "- **Type Check**: ${{ needs.core-checks.result }}"
            echo "- **Lint**: ${{ needs.core-checks.result }}"
            echo "- **Format**: ${{ needs.core-checks.result }}"
            echo "- **i18n Validation**: ${{ needs.core-checks.result }}"
            echo "- **Security Audit**: ${{ needs.core-checks.result }}"
            echo "- **Unit Tests**: ${{ needs.core-checks.result }}"
            echo ""
            echo "## Build Checks"
            echo "- **Build**: ${{ needs.build-checks.result }}"
            echo "- **Bundle Size**: ${{ needs.build-checks.result }}"
            echo ""
            echo "## E2E Tests"
            echo "- **E2E Tests**: ${{ needs.e2e-tests.result }}"
            echo ""
            echo "## Accessibility"
            echo "- **Accessibility Tests**: ${{ needs.accessibility.result }}"
            echo "- **Accessibility Audit**: ${{ needs.accessibility.result }}"
            echo ""
            echo "## SEO Audit"
            echo "- **SEO Checks**: ${{ needs.seo-audit.result }}"
            echo ""
            echo "## Security Checks"
            echo "- **Security Audit**: ${{ needs.security-checks.result }}"
            echo ""
            echo "## Performance"
            echo "- **Lighthouse**: ${{ needs.lighthouse.result }}"
            echo ""
            
            # Determine overall status
            FAILED_JOBS=""
            if [ "${{ needs.core-checks.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}Core Checks, "
            fi
            if [ "${{ needs.build-checks.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}Build Checks, "
            fi
            if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}E2E Tests, "
            fi
            if [ "${{ needs.accessibility.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}Accessibility, "
            fi
            if [ "${{ needs.seo-audit.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}SEO Audit, "
            fi
            if [ "${{ needs.security-checks.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}Security Checks, "
            fi
            if [ "${{ needs.lighthouse.result }}" != "success" ]; then
              FAILED_JOBS="${FAILED_JOBS}Lighthouse, "
            fi
            
            if [ -n "$FAILED_JOBS" ]; then
              echo "## Failed Checks"
              echo "${FAILED_JOBS%, }"
              echo ""
              echo "âš ï¸ **Some checks failed. Please review the individual job logs for details.**"
            else
              echo "## All Checks Passed!"
              echo ""
              echo "ğŸ‰ All checks completed successfully!"
            fi
          } >> $GITHUB_STEP_SUMMARY
          
          # Report status but don't fail the summary job itself
          # The individual jobs will show their failures, this just aggregates them
          if [ "${{ needs.core-checks.result }}" != "success" ] || \
             [ "${{ needs.build-checks.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ] || \
             [ "${{ needs.accessibility.result }}" != "success" ] || \
             [ "${{ needs.seo-audit.result }}" != "success" ] || \
             [ "${{ needs.security-checks.result }}" != "success" ] || \
             [ "${{ needs.lighthouse.result }}" != "success" ]; then
            echo "Some checks failed - see summary above for details"
          else
            echo "All checks passed successfully!"
          fi

      - name: Comment on PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coreStatus = '${{ needs.core-checks.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const buildStatus = '${{ needs.build-checks.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const e2eStatus = '${{ needs.e2e-tests.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const a11yStatus = '${{ needs.accessibility.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const seoStatus = '${{ needs.seo-audit.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const securityStatus = '${{ needs.security-checks.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const lighthouseStatus = '${{ needs.lighthouse.result }}' === 'success' ? 'âœ…' : 'âŒ';
            
            const allPassed = coreStatus === 'âœ…' && buildStatus === 'âœ…' && 
                            e2eStatus === 'âœ…' && a11yStatus === 'âœ…' && seoStatus === 'âœ…' &&
                            securityStatus === 'âœ…' && lighthouseStatus === 'âœ…';
            
            const comment = `## ğŸ“Š All Checks Summary
            
            | Check | Status |
            |-------|--------|
            | Core Checks (Type, Lint, Format, Tests) | ${coreStatus} |
            | Build & Bundle Size | ${buildStatus} |
            | E2E Tests | ${e2eStatus} |
            | Accessibility | ${a11yStatus} |
            | SEO Audit | ${seoStatus} |
            | Security Checks | ${securityStatus} |
            | Lighthouse Performance | ${lighthouseStatus} |
            
            ${allPassed ? 'âœ… **All checks passed!**' : 'âŒ **Some checks failed. Please review the logs.**'}
            
            [View full workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

